<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phone Tracker Admin</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<h1>Phone Tracker Admin</h1>

<div class="controls">
  <button id="generateBind">Generate Bind Link</button>
  <input id="bindLink" type="text" readonly placeholder="Bind link will appear here">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBbihHNrD7_Gx6QdyunHBoYDi_41hcYyBQ",
  authDomain: "phone-tracker-fd98d.firebaseapp.com",
  projectId: "phone-tracker-fd98d",
  storageBucket: "phone-tracker-fd98d.firebasestorage.app",
  messagingSenderId: "906380468882",
  appId: "1:906380468882:web:83315c6838b4bfc486fc4b",
  measurementId: "G-CWNRYX9F4D"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([14.5995,120.9842],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
setTimeout(()=>map.invalidateSize(),500);

const markers = {};

// Battery color helper
function batteryColor(level){
  return level>=70?'#4caf50':level>=30?'#ffeb3b':'#f44336';
}

function createMarker(lat,lng,name,battery,charging,updated){
  // Charging icon overlay if charging
  const chargingIcon = charging==='Charging' ? '⚡' : '';
  const iconHTML = `<div class="pulse-div" style="background:${batteryColor(battery)};border:2px solid ${batteryColor(battery)}">${chargingIcon}</div>`;
  
  const icon = L.divIcon({
    className:'',
    html: iconHTML,
    iconSize:[24,24],
    iconAnchor:[12,12]
  });

  const mk = L.marker([lat,lng],{icon}).addTo(map);
  mk.bindPopup(`<b>${name}</b><br>Battery: ${battery||'N/A'}% (${charging||'N/A'})<br>Last updated: ${new Date(updated).toLocaleTimeString()}`);
  mk.options.name = name;
  return mk;
}

function moveMarkerSmooth(marker,lat,lng,updated,battery,charging){
  if(!marker||!marker.getLatLng) return;
  const frames = 20;
  const startLat = marker.getLatLng().lat;
  const startLng = marker.getLatLng().lng;
  const dLat = (lat-startLat)/frames;
  const dLng = (lng-startLng)/frames;
  let i=0;

  function step(){
    if(i<frames){
      marker.setLatLng([startLat+dLat*i, startLng+dLng*i]);
      i++;
      requestAnimationFrame(step);
    }else{
      marker.setLatLng([lat,lng]);
      // Update popup and icon with battery + charging
      const chargingIcon = charging==='Charging'?'⚡':'';
      marker.setIcon(L.divIcon({className:'',html:`<div class="pulse-div" style="background:${batteryColor(battery)};border:2px solid ${batteryColor(battery)}">${chargingIcon}</div>`,iconSize:[24,24],iconAnchor:[12,12]}));
      marker.setPopupContent(`<b>${marker.options.name}</b><br>Battery: ${battery||'N/A'}% (${charging||'N/A'})<br>Last updated: ${new Date(updated).toLocaleTimeString()}`);
    }
  }
  step();
}

const devicesRef = collection(db,"devices");
onSnapshot(devicesRef, snapshot=>{
  snapshot.docChanges().forEach(change=>{
    const id = change.doc.id;
    const data = change.doc.data();
    if(!data || typeof data.latitude!=='number' || typeof data.longitude!=='number') return;

    if(change.type==='added'){
      markers[id] = createMarker(data.latitude,data.longitude,data.name,data.battery,data.charging,data.updated);
    }else if(change.type==='modified'){
      if(markers[id]) moveMarkerSmooth(markers[id],data.latitude,data.longitude,data.updated,data.battery,data.charging);
      else markers[id] = createMarker(data.latitude,data.longitude,data.name,data.battery,data.charging,data.updated);
    }else if(change.type==='removed'){
      if(markers[id]){ map.removeLayer(markers[id]); delete markers[id]; }
    }
  });

  const allLatLngs = Object.values(markers).map(m=>m.getLatLng()).filter(Boolean);
  if(allLatLngs.length){
    const group = L.featureGroup(Object.values(markers));
    try{ map.fitBounds(group.getBounds().pad(0.5)); }catch(e){}
  }
});

document.getElementById('generateBind').addEventListener('click',()=>{
  let url = window.location.href;
  if(url.endsWith('index.html')) url = url.replace(/index\.html$/,'bind.html');
  else if(url.endsWith('/')) url += 'bind.html';
  else url += '/bind.html';
  const input = document.getElementById('bindLink');
  input.value = url;
  input.select();
  try { document.execCommand('copy'); }catch(e){}
  alert('Bind link copied: ' + url);
});
</script>
</body>
</html>
