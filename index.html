<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phone Tracker Admin</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<h1>Phone Tracker Admin</h1>

<div class="controls">
  <button id="generateBind">Generate Bind Link</button>
  <input id="bindLink" type="text" readonly placeholder="Bind link will appear here">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const cfg={apiKey:"AIzaSyBbihHNrD7_Gx6QdyunHBoYDi_41hcYyBQ",authDomain:"phone-tracker-fd98d.firebaseapp.com",projectId:"phone-tracker-fd98d",storageBucket:"phone-tracker-fd98d.firebasestorage.app",messagingSenderId:"906380468882",appId:"1:906380468882:web:83315c6838b4bfc486fc4b",measurementId:"G-CWNRYX9F4D"};
firebase.initializeApp(cfg);
const db=firebase.firestore(),map=L.map('map',{zoomControl:true,attributionControl:false}).setView([14.5995,120.9842],5),mks={};
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const batteryColor=l=>l>=70?'#4caf50':l>=30?'#ffeb3b':'#f44336';

function createMarker(lat,lng,name,b,u){
  const icon=L.divIcon({className:'',html:`<div class="pulse-div" style="background:${batteryColor(b)};border:2px solid ${batteryColor(b)}"></div>`,iconSize:[20,20],iconAnchor:[10,10]});
  const mk=L.marker([lat,lng],{icon}).addTo(map);
  mk.bindPopup(`<b>${name}</b><br>Battery: ${b||'N/A'}%<br>Last updated: ${new Date(u).toLocaleTimeString()}`);
  mk.options.name=name; return mk;
}

function moveMarkerSmooth(mk,lat,lng,u,b){
  if(!mk||!mk.getLatLng) return;
  const frames=20,sLat=mk.getLatLng().lat,sLng=mk.getLatLng().lng,dLat=(lat-sLat)/frames,dLng=(lng-sLng)/frames;
  let i=0; function step(){if(i<frames){mk.setLatLng([sLat+dLat*i,sLng+dLng*i]);i++;requestAnimationFrame(step);}else{mk.setLatLng([lat,lng]);mk.setPopupContent(`<b>${mk.options.name}</b><br>Battery: ${b||'N/A'}%<br>Last updated: ${new Date(u).toLocaleTimeString()}`);}} step();
}

db.collection("devices").onSnapshot(s=>{
  s.docChanges().forEach(c=>{
    const id=c.doc.id,d=c.doc.data();
    if(!d||typeof d.latitude!=='number'||typeof d.longitude!=='number') return;
    if(c.type==='added') mks[id]=createMarker(d.latitude,d.longitude,d.name,d.battery,d.updated);
    else if(c.type==='modified') moveMarkerSmooth(mks[id],d.latitude,d.longitude,d.updated,d.battery);
    else if(c.type==='removed'){if(mks[id]){map.removeLayer(mks[id]);delete mks[id];}}
  });
  const ll=Object.values(mks).map(x=>x.getLatLng()).filter(Boolean);
  if(ll.length){const g=L.featureGroup(Object.values(mks));try{map.fitBounds(g.getBounds().pad(0.5));}catch(e){}}
});

document.getElementById('generateBind').addEventListener('click',()=>{
  let url=window.location.href;
  if(url.endsWith('index.html')) url=url.replace(/index\.html$/,'bind.html');
  else if(url.endsWith('/')) url+='bind.html'; else url+='/bind.html';
  const input=document.getElementById('bindLink');input.value=url;
  navigator.clipboard.writeText(url).then(()=>alert('Bind link copied!'));
});
</script>
</body>
</html>
