<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phone Tracker Admin</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<h1>Phone Tracker Admin</h1>

<div class="controls">
  <button id="generateBind">Generate Bind Link</button>
  <input id="bindLink" type="text" readonly placeholder="Bind link will appear here">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBbihHNrD7_Gx6QdyunHBoYDi_41hcYyBQ",
  authDomain: "phone-tracker-fd98d.firebaseapp.com",
  projectId: "phone-tracker-fd98d",
  storageBucket: "phone-tracker-fd98d.firebasestorage.app",
  messagingSenderId: "906380468882",
  appId: "1:906380468882:web:83315c6838b4bfc486fc4b",
  measurementId: "G-CWNRYX9F4D"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Map
const map = L.map('map', { zoomControl:true, attributionControl:false }).setView([14.5995,120.9842],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const markers = {};

// Color based on battery
function batteryColor(level){
  if(level>=70) return '#4caf50';
  if(level>=30) return '#ffeb3b';
  return '#f44336';
}

function createMarker(lat, lng, name, battery, updated){
  const color = batteryColor(battery);
  const divIcon = L.divIcon({
    className:'',
    html:`<div class="pulse-div" style="background:${color};border:2px solid ${color}"></div>`,
    iconSize:[20,20],
    iconAnchor:[10,10]
  });
  const m = L.marker([lat,lng],{icon:divIcon}).addTo(map);
  m.bindPopup(`<b>${name}</b><br>Battery: ${battery || 'N/A'}%<br>Last updated: ${new Date(updated).toLocaleTimeString()}`);
  m.options.name = name;
  return m;
}

function moveMarkerSmooth(marker, lat, lng, updated, battery){
  if(!marker || !marker.getLatLng) return;
  const frames=20;
  const startLat = marker.getLatLng().lat;
  const startLng = marker.getLatLng().lng;
  let i=0;
  const dLat = (lat-startLat)/frames;
  const dLng = (lng-startLng)/frames;

  function step(){
    if(i<frames){
      marker.setLatLng([startLat+dLat*i, startLng+dLng*i]);
      i++;
      requestAnimationFrame(step);
    } else {
      marker.setLatLng([lat,lng]);
      marker.setPopupContent(`<b>${marker.options.name}</b><br>Battery: ${battery || 'N/A'}%<br>Last updated: ${new Date(updated).toLocaleTimeString()}`);
    }
  }
  step();
}

// Firestore listener
db.collection("devices").onSnapshot(snapshot=>{
  snapshot.docChanges().forEach(change=>{
    const id = change.doc.id;
    const data = change.doc.data();
    if(!data || typeof data.latitude!=='number'||typeof data.longitude!=='number') return;

    if(change.type==='added'){
      markers[id] = createMarker(data.latitude,data.longitude,data.name,data.battery,data.updated);
    } else if(change.type==='modified'){
      moveMarkerSmooth(markers[id], data.latitude, data.longitude, data.updated, data.battery);
    } else if(change.type==='removed'){
      if(markers[id]){ map.removeLayer(markers[id]); delete markers[id]; }
    }
  });

  const allLatLngs = Object.values(markers).map(m=>m.getLatLng()).filter(Boolean);
  if(allLatLngs.length){
    const group = L.featureGroup(Object.values(markers));
    try{ map.fitBounds(group.getBounds().pad(0.5)); }catch(e){}
  }
});

// Generate bind link
document.getElementById('generateBind').addEventListener('click',()=>{
  let url = window.location.href;
  if(url.endsWith('index.html')) url = url.replace(/index\.html$/,'bind.html');
  else if(url.endsWith('/')) url+='bind.html';
  else url+='/bind.html';
  const input = document.getElementById('bindLink');
  input.value = url;
  navigator.clipboard.writeText(url).then(()=>alert('Bind link copied!'));
});
</script>
</body>
</html>
