<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone Tracker Admin</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
<h1>Phone Tracker Admin</h1>

<div style="text-align:center; margin:10px;">
  <button id="generateBind">Generate Bind Link</button>
  <input type="text" id="bindLink" readonly style="width:70%; text-align:center; margin-left:10px;"/>
</div>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import L from "https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet-src.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAz9MekmxZ3n32vzVkjXpQZdWCA-zzUH9o",
  authDomain: "phone-tracker-82286.firebaseapp.com",
  projectId: "phone-tracker-82286",
  storageBucket: "phone-tracker-82286.appspot.com",
  messagingSenderId: "343819739526",
  appId: "1:343819739526:web:10acad845264bd81c18c07"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Initialize map
const map = L.map('map').setView([14.5995, 120.9842], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let markers = {};
const devicesRef = collection(db, "devices");

onSnapshot(devicesRef, snapshot => {
  snapshot.docChanges().forEach(change => {
    const data = change.doc.data();
    const id = change.doc.id;

    if(change.type === "added" || change.type === "modified"){
      if(markers[id]){
        markers[id].setLatLng([data.latitude, data.longitude]);
      } else {
        const marker = L.circleMarker([data.latitude, data.longitude], {
          radius: 10,
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.5
        }).addTo(map).bindPopup(data.name);
        markers[id] = marker;
      }
    }
  });

  const group = Object.values(markers).map(m => m.getLatLng());
  if(group.length) map.fitBounds(group, {padding:[50,50]});
});

// Bind link generator
document.getElementById("generateBind").addEventListener("click", () => {
  const link = window.location.origin + "/bind.html";
  const input = document.getElementById("bindLink");
  input.value = link;
  input.select();
  document.execCommand("copy");
  alert("Bind link copied: " + link);
});
</script>
</body>
</html>
